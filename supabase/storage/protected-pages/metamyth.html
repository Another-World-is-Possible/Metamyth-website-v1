<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METAMYTH: A Journey of Transformation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="application/json" id="persona-base">
    { "name": "Metamyth Guide", "examples": [] }
    </script>
    <script type="text/plain" id="prompt-template-standard">
    You are a wise, encouraging, and insightful guide named Kairos. Your purpose is to help the user author their personal Metamyth.
    **Your Task:** Analyze the user's answers for the "{{stageTitle}}" stage. Your goal is NOT to grade the user, but to act as a positive mirror.
    1.  **Evaluate for Sincerity and Depth:** Do the answers feel authentic and thoughtful?
    2.  **Provide Encouragement:** Start your feedback with a positive and affirming statement.
    3.  **Determine Next Step:** If answers show sincere effort, set "continue" to `true`. If an answer is extremely brief or off-topic, set "continue" to `false` and provide a single, gentle summary explaining what could be improved.
    4.  **Identify Fields for Attention:** If "continue" is `false`, identify the specific fields that need more reflection in the `invalidIndexes` array.
    **Response Format:** You MUST respond in valid JSON format only (e.g., `{"continue": false, "summary": "...", "invalidIndexes": [0, 2]}`).
    </script>
    <script type="text/plain" id="prompt-template-synthesis">
    You are a wise, encouraging, and insightful guide named Kairos. Your purpose is to help the user synthesize their reflections.
    **Your Task:** Analyze the user's synthesis answer for the "{{stageTitle}}" stage.
    1.  **Evaluate for Coherence:** Does the synthesis successfully combine the core ideas from the preceding stages?
    2.  **Determine Next Step:** If the synthesis is thoughtful, set "continue" to `true`. If it lacks a unified theme, set "continue" to `false` and provide a summary that guides them on how to better weave the threads together.
    3.  **Identify Fields for Attention:** This will usually just be index `0`.
    **Response Format:** You MUST respond in valid JSON format only.
    </script>

    <style>
        /* Font Loading - Match Main Website */
        @font-face {
            font-family: 'AngleFairy2024';
            src: url('/attached_assets/Angle & Fairy_1755895085623.otf?v=2024') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'GrillagesBold2024';
            src: url('/attached_assets/GrillagesBold_1756520423796.ttf?v=2024') format('truetype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        
        :root {
            --bg-main: #1D4241;
            --bg-card: #183332;
            --text-main: #FAF0E6; /* Soft off-white cream - main text color */
            --text-heading: #D4AF37; /* Gold */
            --text-muted: #FAF0E6; /* Soft off-white cream for muted text too */
            --border-color: #2c5d5b;
            --accent-teal: #14B8A6; /* Teal main accent */
            --accent-teal-dark: #0F766E;
            --accent-crimson: #DC2626; /* Crimson for negative elements */
            --accent-gold: #D4AF37; /* Gold accent */
        }
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'GrillagesBold2024', serif;
            font-weight: 700;
        }
        h1, h2, h3, h4 {
            font-family: 'AngleFairy2024', serif !important;
            color: var(--text-heading);
            letter-spacing: 0.05em;
            font-weight: normal !important;
        }
        .content-card {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(20, 184, 166, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 0 20px rgba(0, 0, 0, 0.5),
                inset 0 0 30px rgba(20, 184, 166, 0.1);
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent;
            color: var(--text-muted);
            padding: 0.75rem 1rem;
        }
        .nav-link.active {
            background-color: rgba(20, 184, 166, 0.05);
            color: var(--accent-teal);
            border-left-color: var(--accent-teal);
        }
        .nav-link:hover {
            background-color: rgba(20, 184, 166, 0.1);
            color: var(--accent-gold);
        }
        textarea, .compass-input, input[type="text"], input[type="range"] {
            border: 2px solid var(--accent-teal) !important;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--text-main);
            padding: 12px;
            font-family: 'GrillagesBold2024', serif;
            transition: all 0.3s ease;
        }
        
        textarea:focus, input:focus {
            outline: none;
            box-shadow: 
                0 0 10px rgba(20, 184, 166, 0.5),
                0 0 20px rgba(20, 184, 166, 0.2);
            border-color: var(--accent-teal) !important;
        }
        
        /* CTA Button Styles - Matching Main Site */
        .cta-button-base {
            position: relative;
            padding: 12px 24px;
            background: var(--button-gradient);
            color: var(--button-text-color);
            font-family: 'AngleFairy2024', serif;
            font-weight: bold;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            border-radius: 16px;
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.1);
            text-shadow: var(--button-text-glow);
        }
        
        .cta-button-base:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 0 30px var(--button-glow-color),
                0 0 60px var(--button-glow-color),
                0 0 90px var(--button-glow-color),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
        }
        
        .cta-button-gold {
            --button-gradient: linear-gradient(90deg, #f39c12, #f1c40f, #f4d03f);
            --button-text-color: #2c3e50;
            --button-glow-color: rgba(241, 196, 15, 0.8);
            --button-text-glow: 
                0 0 8px rgba(255, 255, 255, 0.9),
                0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .cta-button-teal {
            --button-gradient: linear-gradient(90deg, #16a085, #1abc9c, #48c9b0);
            --button-text-color: #2c3e50;
            --button-glow-color: rgba(26, 188, 156, 0.8);
            --button-text-glow:
                0 0 8px rgba(255, 255, 255, 0.9),
                0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .artifiction-icon {
            font-size: 2.5rem;
            margin-right: 1.5rem;
            line-height: 1;
        }
        .stage-content { display: none; }
        .stage-content.active {
            display: block;
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: auto;
            margin: 2rem auto;
        }
        .prose {
            color: var(--text-main);
            line-height: 1.8;
            font-family: 'GrillagesBold2024', serif;
            font-weight: 700;
        }
        .prose h3 {
            font-size: 1.5rem;
            font-weight: normal;
            margin-top: 2em;
            margin-bottom: 0.5em;
            color: var(--text-heading);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            font-family: 'AngleFairy2024', serif !important;
        }
        .prose p { 
            margin-bottom: 1.25em;
            font-family: 'GrillagesBold2024', serif;
            font-weight: 700;
        }
        .prose strong { color: var(--accent-teal); }
        .nav-arc-header {
            color: #fff;
            font-weight: normal;
            letter-spacing: 0.1em;
            font-family: 'AngleFairy2024', serif !important;
        }
        .crimson-text { color: var(--accent-crimson); }
        .text-gold { color: var(--accent-gold); }
        .border-gold { border-color: var(--accent-gold); }
        .text-teal { color: var(--accent-teal); }
        
        .glow-title {
            text-shadow: 
                0 0 10px rgba(20, 184, 166, 0.8),
                0 0 20px rgba(20, 184, 166, 0.4),
                0 0 30px rgba(20, 184, 166, 0.2);
        }
        
        .glow-arc {
            text-shadow: 
                0 0 8px rgba(255, 215, 0, 0.8),
                0 0 16px rgba(255, 215, 0, 0.4);
            color: var(--accent-gold) !important;
        }
        
        .glow-progress {
            background: linear-gradient(90deg, 
                var(--accent-teal) 0%, 
                var(--accent-gold) 50%, 
                #f1c40f 100%);
            box-shadow: 
                0 0 15px rgba(20, 184, 166, 0.6),
                0 0 30px rgba(212, 175, 55, 0.4),
                0 0 45px rgba(241, 196, 15, 0.3);
        }
        
        .glow-indicator {
            box-shadow: 
                0 0 15px rgba(20, 184, 166, 0.4),
                0 0 30px rgba(20, 184, 166, 0.2);
        }
        
        .glow-button {
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
            border-color: var(--accent-gold) !important;
            color: var(--accent-gold) !important;
        }
        
        .glow-button:hover {
            background-color: var(--accent-gold) !important;
            color: black !important;
            box-shadow: 
                0 0 10px rgba(255, 215, 0, 0.6),
                0 0 20px rgba(255, 215, 0, 0.3);
        }
        .synthesis-box {
            background-color: rgba(0,0,0,0.1);
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-style: italic;
            color: var(--text-main);
            font-family: 'GrillagesBold2024', serif;
            font-weight: 700;
        }
        .ornamental-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border-color), transparent);
            margin: 3rem 0;
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; color: white; flex-direction: column; justify-content: center; align-items: center; font-family: 'AngleFairy2024', serif;">
      <div class="text-4xl">Kairos is reflecting...</div>
      <div class="mt-4 text-ancient-gold text-6xl animate-spin-slow">üåÄ</div>
    </div>

    <div class="flex flex-col md:flex-row">
        <nav id="sidebar" class="w-full md:w-80 bg-black bg-opacity-20 p-4 md:p-6 flex-shrink-0">
            <h1 class="text-3xl font-bold text-white mb-8">METAMYTH</h1>
            <div id="nav-container" class="space-y-1"></div>
        </nav>
        <main class="flex-1 p-4 md:p-10">
            <div id="content-container"></div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // The `stages` array remains the structural source of truth for order and identity.
    const stages = [
        { id: 'intro', title: 'Awaken', arc: 'Preamble', icon: '‚ú®' },
        { id: 'origin', title: 'The Origin Story', arc: 'Preamble', icon: 'üå±' },
        { id: 'arc1', title: 'ARC I: THE CALL TO ADVENTURE', arc: 'ARC I', icon: 'üîî' },
        { id: 'dragon', title: 'The Dragon', arc: 'ARC I', icon: 'üêâ' },
        { id: 'threshold', title: 'The Threshold', arc: 'ARC I', icon: 'üåÄ' },
        { id: 'shield', title: 'The Shield', arc: 'ARC I', icon: 'üõ°Ô∏è' },
        { id: 'pearl', title: 'The Pearl', arc: 'ARC I', icon: '‚ö™' },
        { id: 'calling_synthesis', title: 'Artifact I: The Calling', arc: 'ARC I', icon: 'üì£' },
        { id: 'arc2', title: 'ARC II: THE QUEST', arc: 'ARC II', icon: 'üó∫Ô∏è' },
        { id: 'star', title: 'The Star', arc: 'ARC II', icon: '‚≠ê' },
        { id: 'character', title: 'The Character', arc: 'ARC II', icon: 'üë§' },
        { id: 'banner', title: 'The Banner', arc: 'ARC II', icon: 'üö©' },
        { id: 'sword', title: 'The Sword', arc: 'ARC II', icon: '‚öîÔ∏è' },
        { id: 'quest_synthesis', title: 'Artifact II: The Quest', arc: 'ARC II', icon: 'üìú' },
        { id: 'arc3', title: 'ARC III: WHAT IS POSSIBLE', arc: 'ARC III', icon: 'üåå' },
        { id: 'looking_glass', title: 'The Looking Glass', arc: 'ARC III', icon: 'üîÆ' },
        { id: 'transformation', title: 'The Transformation', arc: 'ARC III', icon: 'ü¶ã' },
        { id: 'globe', title: 'The Globe', arc: 'ARC III', icon: 'üåç' },
        { id: 'map', title: 'The Map', arc: 'ARC III', icon: 'üó∫Ô∏è' },
        { id: 'vision_synthesis', title: 'Artifact III: What is Possible', arc: 'ARC III', icon: 'üî≠' },
        { id: 'arc4', title: 'ARC IV: THE JOURNEY', arc: 'ARC IV', icon: 'üë£' },
        { id: 'fountain', title: 'The Fountain', arc: 'ARC IV', icon: '‚õ≤' },
        { id: 'ethos', title: 'The Ethos', arc: 'ARC IV', icon: 'üìú' },
        { id: 'plot', title: 'The Road', arc: 'ARC IV', icon: 'üõ§Ô∏è' },
        { id: 'compass', title: 'The Compass', arc: 'ARC IV', icon: 'üß≠' },
        { id: 'mission_synthesis', title: 'Artifact IV: The Journey', arc: 'ARC IV', icon: 'üéØ' },
        { id: 'arc5', title: 'ARC V: THE REQUEST', arc: 'ARC V', icon: 'üè°' },
        { id: 'grail', title: 'The Grail', arc: 'ARC V', icon: 'üèÜ' },
        { id: 'initiation', title: 'The Initiation', arc: 'ARC V', icon: 'üåâ' },
        { id: 'campfire', title: 'The Campfire', arc: 'ARC V', icon: 'üî•' },
        { id: 'message', title: 'The Message', arc: 'ARC V', icon: 'üì¢' },
        { id: 'kindred_synthesis', title: 'Artifact V: The Request', arc: 'ARC V', icon: 'üåü' }
    ];
    window.stages = stages; // Make globally accessible

    const navContainer = document.getElementById('nav-container');
    const contentContainer = document.getElementById('content-container');
    let contentData = {}; // This will hold all text content from the JSON file

    async function initializeApp() {
        try {
            const response = await fetch(`${window.location.origin}/metamyth-journey.json`);
            contentData = await response.json();
        } catch (error) {
            console.error("Fatal Error: Could not load metamyth-journey.json", error);
            contentContainer.innerHTML = `<div class="content-card text-red-500"><h2>Error</h2><p>Could not load the journey's content. Please check the console.</p></div>`;
            return;
        }

        let currentArc = '';
        stages.forEach((stage, index) => {
            // Build navigation
            if (stage.arc !== currentArc) {
                currentArc = stage.arc;
                const arcHeader = document.createElement('h3');
                arcHeader.className = 'nav-arc-header text-lg uppercase mt-6 mb-2 px-4';
                arcHeader.textContent = currentArc;
                navContainer.appendChild(arcHeader);
            }
            const navLink = document.createElement('a');
            navLink.href = '#';
            navLink.id = `nav-${stage.id}`;
            navLink.className = 'nav-link flex items-center rounded-md';
            navLink.innerHTML = `<span class="mr-3">${stage.icon}</span> ${stage.title}`;
            navLink.onclick = (e) => { e.preventDefault(); showStage(index); };
            navContainer.appendChild(navLink);

            // Build content panes from JSON data
            const stageDiv = document.createElement('div');
            stageDiv.id = stage.id;
            stageDiv.className = 'stage-content';
            stageDiv.innerHTML = generateStageHTML(stage, contentData[stage.id]);
            contentContainer.appendChild(stageDiv);
        });
        showStage(0);
    }

    function generateStageHTML(stage, content) {
        if (!content) return `<div class="content-card"><h2 class="text-4xl">${stage.title}</h2><p>Content for this stage is missing in the JSON file.</p></div>`;

        // Handle ARC title cards
        if (stage.id.startsWith('arc')) {
            return `
                <div class="content-card">
                    <h2 class="text-4xl">${content.title}</h2>
                    ${(content.prose || []).map(p => `<p class="prose max-w-none mt-4">${p}</p>`).join('')}
                    <div class="text-center mt-10">
                        <button class="cta-button-base cta-button-teal stage-submit-button" data-stage-id="${stage.id}">${content.buttonText}</button>
                    </div>
                </div>`;
        }

        // Handle standard stages with fields
        const fieldsHTML = (content.fields || []).map((field, index) => `
            <div>
                <label class="font-semibold text-lg block mb-2">${field.label}</label>
                <p class="text-sm mb-3">${field.prompt}</p>
                <textarea class="w-full" data-field-index="${index}" rows="4"></textarea>
            </div>
        `).join('');

        // Handle synthesis sections
        const synthesisHTML = content.synthesis ? `
            <div class="synthesis-box border border-gold mt-8">
                <label class="font-semibold text-lg text-gold block mb-2">${content.synthesis.label}</label>
                <p class="text-sm mb-3">${content.synthesis.prompt}</p>
                <textarea class="w-full" data-field-index="${(content.fields || []).length}" rows="6"></textarea>
            </div>
        ` : '';
        
        // Use a different prompt template for synthesis-only pages
        const promptTemplate = stage.id.includes('synthesis') ? 'prompt-template-synthesis' : 'prompt-template-standard';

        return `
            <div class="content-card">
                <h2 class="text-4xl">${content.title}</h2>
                <p class="prose max-w-none my-4">${content.prose || ''}</p>
                <div class="stage-summary-error bg-red-900/20 border border-red-500/50 text-red-300 p-4 rounded-md my-6" style="display: none;"></div>
                <div class="space-y-8">${fieldsHTML}</div>
                ${synthesisHTML}
                <div class="text-center mt-10">
                    <button class="cta-button-base cta-button-teal stage-submit-button" data-stage-id="${stage.id}" data-prompt-template="${promptTemplate}">
                        ${content.buttonText}
                    </button>
                </div>
            </div>`;
    }

    window.showStage = function(index) {
        document.querySelectorAll('.stage-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

        const stage = stages[index];
        if (!stage) return;

        const stageEl = document.getElementById(stage.id);
        const navEl = document.getElementById(`nav-${stage.id}`);

        if (stageEl) stageEl.classList.add('active');
        if (navEl) navEl.classList.add('active');
    }
    
    initializeApp();
});
</script>

<script src="chatbot.js"></script>
<script src="metamyth-journey.js"></script>

<script>
  const sendHeight = () => {
    // We use document.documentElement.scrollHeight to get the full height of the content
    const height = document.documentElement.scrollHeight;
    // Send a message to the parent window (the React app) with the calculated height
    window.parent.postMessage({ type: 'iframeResize', height: height }, '*');
  };

  // Send the height once the initial content is loaded
  window.addEventListener('load', sendHeight);

  // Use a ResizeObserver to automatically send the new height whenever the content size changes
  const resizeObserver = new ResizeObserver(sendHeight);
  resizeObserver.observe(document.body);
</script>
</body>
</html>